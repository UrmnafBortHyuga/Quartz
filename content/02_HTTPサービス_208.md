---
aliases: 
created: 2024-06-22T08:43 (UTC +09:00)
tags:
  - LPIC202
---
# 10.1 Webサーバの設定

**Apache HTTP Server【注1】**（以下Apache） は、The Apache Software Foundationによって開発されているWebサーバで、現在2.0 系、2.2 系、2.4 系がリリースされています。2.0 系では、MPM（マルチプロセッシングモジュール）機能が実装されたほか、IPv6にも対応しました。2.2系では、キャッシュの改良や負荷分散機能など、パフォーマンス面におけるさまざまな改善がなされました。2.4 系では、パフォーマンスの向上、非同期I/Oサポート、メモリ使用量の削減、各種モジュールの機能強化などが図られています。

**コラム**
## MPM
Apacheは、MPM（Multi Processing Module）という基本モジュールによって動作が大きく異なります。代表的なMPMとしてprefork、worker、perchild、eventがあります。preforkは1.3系のApacheと同じマルチプロセスモデルで、リクエストごとに子プロセスを割り当てます。同時に接続するクライアントが増えると、Apacheの子プロセスも増大します。workerはスレッドに対応したモデルで、クライアントからのリクエストを子プロセス内のスレッドで処理し、負荷が増えると子プロセスも増やします。バーチャルホスト向けのperchildもスレッド対応ですが、子プロセスの数を固定し、負荷に応じてスレッドを増減します。eventはworkerと似ていますが、キープアライブの処理が異なります。それぞれに長所も短所もあり、MPMによって動作しないソフトウェアもあります。たとえばPHPはpreforkを前提としているので、他のMPMでは正常に動作しない可能性があります。どのMPMを採用するかは、設定ファイルで設定します。CentOS7の場合、デフォルトはpreforkです。

DSOは動的共有オジェクト
![[_resource/Pasted image 20240512232448.png]]
なお静的モジュールは、本体とモジュールが一体で動作するため、モジュール組み込みにかかる負荷が低くなります。一方DSOモジュールは、読み込む際に発生するオーバーヘッドにより、静的なものに比べApacheの起動が遅くなります。
## **10.1.1** Apache のインストール

Apacheをインストールするには、ディストリビューションごとに用意されているパッケージを利用する方法と、ソースからコンパイルする方法があります。ソースからインストールする場合は、一般的なソフトウェアのインストールと同様に、configure〜make〜make installを実行します。configureスクリプトでは、さまざまなオプションを指定することができます。

表10-1　configureスクリプトの代表的なオプション

|オプション|説明|
|---|---|
|--prefix=_ディレクトリ_|インストール先ディレクトリ|
|--sysconfdir=_ディレクトリ_|設定ファイルのディレクトリ|
|--enable-module=_モジュール_|標準モジュールを組み込む|
|--disable-module=_モジュール_|標準モジュールを組み込まない|
|--enable-shared=_モジュール_|標準モジュールをDSOで組み込む|
|--disable-shared=_モジュール_|標準モジュールをDSOで組み込まない|

次の例では、インストール先ディレクトリを/usr/local/apacheにし、sslモジュールを有効にしています。

```
$ ./configure --prefix=/usr/local/apache --enable-module=ssl
```

**参考** 
一度configureを実行すると、config.statusファイルが作成されます。このスクリプトファイルを実行すると、以前と同じオプションを使って再度configureを実行できます。

CentOSやFedoraなどでは、httpdパッケージをインストールします。

```
# yum install httpd
```

Debian GNU/LinuxやUbuntuでは、apache2パッケージをインストールします。

```
# apt-get install apache2
```

## **10.1.2** Apache の設定

Apacheのメイン設定ファイルは**httpd.conf**ですが、ディストリビューションによってインストール先やファイル名が異なります。また、機能ごとに複数の設定ファイルに分割し、httpd.confでインクルードして利用するのが一般的です。

表10-2　Apacheの主な設定ファイル（ソースからインストール）

|ファイル/ ディレクトリ|説明|
|---|---|
|/usr/local/apache2/conf/httpd.conf|メイン設定ファイル|
|/usr/local/apache2/conf/extra/|補助設定ファイルを格納するディレクトリ|
|httpd-languages.conf|言語・文字コードの設定|
|httpd-userdir.conf|一般ユーザーのホームディレクトリ設定|
|httpd-info.conf|server-info、server-statusの設定|
|httpd-vhosts.conf|バーチャルホストの設定|
|httpd-default.conf|デフォルトのサーバ全般設定|
|httpd-ssl.conf|SSL/TLSの設定|

表10-3　Apacheの主な設定ファイル（Red Hat 系ディストリビューション）

|ファイル/ ディレクトリ|説明|
|---|---|
|/etc/httpd/conf/httpd.conf|メイン設定ファイル|
|/etc/httpd/conf.d/|補助設定ファイルを格納するディレクトリ|
|ssl.conf|SSL/TLSの設定|
|php.conf|PHPモジュールの設定|
|perl.conf|Perlモジュールの設定|

表10-4　Apacheの設定ファイル（Debian 系ディストリビューション）

|ファイル/ ディレクトリ|説明|
|---|---|
|/etc/apache2/apache2.conf|メイン設定ファイル|
|/etc/apache2/|補助設定ファイルを格納するディレクトリ|
|/etc/apache2/ports.conf|ポートの設定|
|/etc/apache2/sites-enabled/|サイト定義ファイルへのリンク|
|/etc/apache2/sites-available/|サイト定義ファイル|

httpd.confの設定項目は**ディレクティブ**と呼ばれ、次の書式で記述します。

_書式：_ `ディレクティブ名 設定値`

次の例では、DocumentRootディレクティブに「/var/www/html」という値を設定しています。

▶ **httpd.confの書式例**

```
DocumentRoot /var/www/html
```

また、適用範囲のファイル、ディレクトリ、URLを指定することもできます。その場合、書式は次のようになります。


_書式：_`<Files ファイル名> ... </Files>`
_書式：_ `<Directory ディレクトリ名> ... </Directory>`
_書式：_ `<Location URL > ... </Location>`

  次の例では、/homeディレクトリ以下に適用する設定を記述しています。この設定は、たとえば/var/www/htmlといったディレクトリ以下には影響を与えません。

▶ **httpd.confの書式例**

```
<Directory "/home/*">
    AllowOverride None
    Options ExecCGI
</Directory>
```

次に示すのはhttpd.confの設定例です。

▶ **httpd.confの設定例**

```
# Apacheの設定ファイルやログファイルの起点となるトップディレクトリ
ServerRoot "/usr/local/apache2"

# 待ち受けポート番号
Listen 80

# ロードするモジュール
LoadModule authn_file_module modules/mod_authn_file.so
LoadModule authn_core_module modules/mod_authn_core.so
LoadModule authz_host_module modules/mod_authz_host.so
LoadModule authz_groupfile_module modules/mod_authz_groupfile.so
LoadModule authz_user_module modules/mod_authz_user.so
（省略）

# 実行ユーザーと実行グループ
User apache
Group apache

# バージョン情報等の出力設定
ServerSignature On
ServerTokens Full

# 管理者のメールアドレス
ServerAdmin webmaster@example.com

# ホスト名
ServerName www.example.com

# / ディレクトリ以下の設定
<Directory />
    AllowOverride none
    Require all denied
</Directory>

# ドキュメントルート
DocumentRoot "/var/www/html"

# ドキュメントルートディレクトリ以下の設定
<Directory "/var/www/html">
    Options Indexes FollowSymLinks
    AllowOverride None
    Require all granted
</Directory>

# dirモジュールが有効であればディレクトリインデックスを設定
<IfModule dir_module>
    DirectoryIndex index.html
</IfModule>

# エラーログファイルのパス
ErrorLog "logs/error_log"

# ログレベル
LogLevel warn

# 有用なログフォーマットの定義
LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
LogFormat "%h %l %u %t \"%r\" %>s %b" common

# combinedフォーマットでアクセスログを蓄積
CustomLog "logs/access_log" combined

# エイリアスの設定
Alias /icons/ "/var/www/icons/"
Alias /error/ "/var/www/error/"

# CGI用エイリアスの定義
ScriptAlias /cgi-bin/ "/var/www/cgi-bin/"

# CGIプログラムディレクトリの定義
<Directory "/var/www/cgi-bin">
    AllowOverride None
    Options None
    Require all granted
</Directory>

# エラーとエラーページの設定
ErrorDocument 500 "The server made a boo boo."
ErrorDocument 404 /missing.html

# 他の設定ファイル(*.conf)の読み込み
IncludeOptional conf.d/*.conf
```

## **10.1.3** httpd.conf の主な設定

以下に、主なディレクティブの設定例を紹介します。

_書式：_ `ServerTokens Prod|Major|Minor|Min|OS|Full`

HTTPヘッダ内に出力されるバージョン情報（バナー情報）を指定します。サーバ名やバージョン番号は攻撃ツールを選定するためのヒントになり得ますので、できるだけ情報は出さないようにします。通常は「Prod」でよいでしょう。

表10-5　ServerTokensディレクティブの設定値

|設定値|出力例|
|---|---|
|Prod|Server: Apache|
|Major|Server: Apache/2|
|Minor|Server: Apache/2.4|
|Min|Server: Apache/2.4.6|
|OS|Server: Apache/2.4.6 (CentOS)|
|Full|Server: Apache/2.4.6 (CentOS) OpenSSL/1.0.1e-fips PHP/5.4.16 mod_perl/2.0.10 Perl/v5.16.3|

_書式：_ `ServerRoot パス`

httpdが利用するトップディレクトリを指定します。

_書式：_ `ServerName サーバのホスト名`

Apacheが稼働しているホストのホスト名を指定します。

_書式：_ `ServerAdmin メールアドレス`

サーバ管理者の連絡先メールアドレスを指定します。エラーページなどに表示されるようになります。

_書式：_ `StartServers 子プロセス数`

_書式：_ `MinSpareServers 子プロセス数`

_書式：_ `MaxSpareServers 子プロセス数`

Apacheでは複数のプロセスが処理を分担します。クライアントからの接続を親プロセスが待ち受け、個々のクライアントごとの対応は子プロセスが処理します。StartServersは起動時の数、MinSpareServersは待機子プロセスの最小数、MaxSpareServersは待機子プロセスの最大数を示します。待機している子プロセス数よりもクライアント数が大きくなれば、不足分の子プロセスをその時点で起動しなければならず、レスポンスが遅くなってしまいます。待機している子プロセス数が多ければクライアントからのアクセスに素早く対応できますが、メモリの消費量は大きくなってしまいます。

_書式：_ `ServerLimits 子プロセス数`

生成される子プロセスの設定可能な上限を指定します。

_書式:_ `MaxClients 同時接続数`

_書式：_ `MaxRequestWorkers 同時接続数`

最大同時接続数を指定します。Apache 2.2ではMaxClientsを、Apache 2.4ではMaxRequestWorkersを使います【注2】。

_書式：_ `Timeout タイムアウト時間`

クライアントからの接続がタイムアウトになる時間を秒数で指定します。

_書式：_ `KeepAlive on|off`

_書式：_ `MaxKeepAliveRequests 上限リクエスト数`

_書式：_ `KeepAliveTimeout タイムアウト時間`

**キープアライブ**とは、WebサーバとWebブラウザの間で、TCP接続をキープすることです。つまり、1つのTCP接続を使って複数のHTTP処理要求をすることができるので、パフォーマンスが向上します。KeepAliveはキープアライブの有効/無効をon/offで指定します。MaxKeepAliveRequestsは、1回のTCP接続における最大リクエスト数を指定します。KeepAliveTimeoutは1回のTCP接続におけるタイムアウト時間を秒で指定します。

NOTE
HTTPでは、1リクエスト＆レスポンスごとにTCPコネクションは切断されるのが基本です。たとえば画像が50枚あるページを表示するには、HTMLファイルと画像それぞれに「TCPコネクション開始」「HTTP リクエスト」「HTTP レスポンス」「TCP コネクション切断」を行います。キープアライブを利用すれば、「TCPコネクション開始」と「TCPコネクション切断」は1回だけで済むので、その分Webページの表示が完了するまでの時間は短くなります。ただし、クライアント側の表示速度よりもコネクション数を重視する場合はoffにしておきます。

_書式：_ `Listen [IP アドレス:]ポート番号`

待ち受けるポート番号を指定します。デフォルトは80 番ポートです。IPアドレスは省略できます。IPv6アドレスを指定する時はアドレスを[ ]でくくり、「`[2001:db8::1]:80`」のように指定します。

_書式：_ `User ユーザー名`

_書式：_ `Group グループ名`

httpd 子プロセスの実行ユーザーと実行グループを指定します。子プロセスはapacheやnobodyなどの一般ユーザー権限で動作します。

_書式：_ `DocumentRoot ディレクトリパス`

ドキュメントルートとなるディレクトリを指定します。

_書式：_ `UserDir 公開ディレクトリ|disabled`

一般ユーザーの公開ディレクトリを指定します。ディレクトリ名はホームディレクトリからの相対パスもしくは絶対パスで指定します。たとえば「public_html」と指定すると、「http://ホスト名/~ユーザー名/」でブラウザからアクセスしたとき、/home/ユーザー名/public_htmlにアクセスすることになります。disabledを指定すると、一般ユーザーのホームディレクトリは公開しません。

_書式：_ `DirectoryIndex インデックスファイル名`

ディレクトリのインデックスとして返すファイル名を指定します。たとえば、

▶ **ディレクトリのインデックス指定**

```
DirectoryIndex index.html index.htm index.php default.php
```

のように設定したとすれば、URLでファイル名が指定されなかった場合、ディレクトリ内にあるindex.html、index.htm、index.php、default.phpが順に検索され、最初に見つかったのものがインデックスページとして表示されます。

**参考**
ApacheはHTTP/1.1コンテントネゴシエーションをサポートしており、ブラウザに応じて自動的に言語やエンコーディングを切り替えられるようになっています。タイプマップ（「〜.var」ファイル）を使う方法と、MultiViewsオプションを使う方法があります。

_書式：_ `ErrorLog ログファイルのパス`

エラーを記録するログファイルを指定します。

_書式：_ `LogLevel ログレベル`

エラーログのログレベルを指定します。

_書式：_ `LogFormat "フォーマット" 書式名`

ログに記録する項目と書式名を定義します。たとえば、次の設定ではcommon形式を定義しています。

▶ **ログフォーマットの定義**

```
LogFormat "%h %l %u %t \"%r\" %>s %b" common
```

ログフォーマットの書式で利用できる主なフォーマット文字列は表10-6のとおりです。

表10-6　主なフォーマット文字列

| フォーマット文字列      | 説明                         |
| -------------- | -------------------------- |
| %a             | リモートIPアドレス                 |
| %A             | ローカルIPアドレス                 |
| %b             | クライアントに送信されたHTTPヘッダ以外のバイト数 |
| %f             | ファイル名                      |
| %h             | リモートホスト（クライアント）            |
| %H             | リクエストプロトコル                 |
| %l             | リモートログ名                    |
| %m             | リモートメソッド                   |
| %r             | リクエストの最初の行                 |
| %t             | サーバがリクエストの処理を終えた時刻         |
| %T             | リクエスト処理にかかった時間             |
| %u             | リクエストをしたユーザー名              |
| %U             | リクエストされたURL                |
| %>s            | サーバがクライアントに返すステータスコード      |
| %{Referer}i    | リクエスト内のRefererヘッダの内容       |
| %{User-agent}i | リクエスト内のUser-agentヘッダの内容    |

_書式：_ `CustomLog ログファイル名 ログ書式名`

アクセスログのログファイル名と、LogFormatで定義したログ書式名を指定します。次の設定では、combined形式でlogs/access_logファイルとしてアクセスログを保存します。

▶ **アクセスログの定義**

```
CustomLog logs/access_log combined
```

_書式：_ `HostnameLookups on|off`

DNSの逆引きを行い、アクセス元のIPアドレスからホスト名を取得します。ログにホスト名を記録したり、ホスト名でアクセス制御を行う場合は有効にします。パフォーマンスを高めるためにはoffを指定します。

_書式：_ `Alias ディレクトリ パス`

ドキュメントルートツリー以外の場所を参照できるようにします。次の例では、「http://ホスト名/images」にアクセスしたとき、ドキュメントルート以下のimagesディレクトリ（/var/www/html/images）ではなく、/home/www/imagesを参照するようにしています。

▶ **エイリアスの指定**

```
Alias /images /home/www/images
```


URLパスの末尾に「/」を指定した場合は、URLアクセス時にも「/」の指定が必要です。たとえば「Alias /images/ /home/www/images/」とした場合、「http://〜/images」ではエイリアスに展開されません。「http://〜/images/」のようにする必要があります。

_書式：_ `Redirect ディレクトリまたはファイル 転送先URL`

指定したURLへ転送（リダイレクト）します【注3】。特定のページ、たとえば/var/www/html/lpi.htmlにアクセスしたときに「[http://www.lpi.org/](http://www.lpi.org/)」に転送されるようにするには、次のように指定します。

▶ **リダイレクトの指定**

```
Redirect /lpi.html http://www.lpi.org/
```

サイト全体を転送するには、次のように指定します。

▶ **サイト全体のリダイレクト**

```
DocumentRoot "/var/www/html"
<Directory />
Redirect / http://www.lpi.org/
</Directory>
```

_書式：_ `ScriptAlias ディレクトリ CGI 格納ディレクトリ`

CGIスクリプト用ディレクトリを指定します。たとえば、

▶ **CGIスクリプト用ディレクトリの指定**

```
ScriptAlias /cgi-bin/ /var/www/cgi-bin/
```

のように設定したとすれば、「http://ホスト名/cgi-bin/sample.cgi」にアクセスしたとき、/var/www/cgi-bin/sample.cgiが実行されます。

_書式：_ `ErrorDocument エラーコード ファイル名|文字列|URL`

エラーが発生した場合の処理を、エラーコードに続けて指定します。「/」で始まるファイル名を指定したときは、ローカルドキュメントが表示されます。文字列を指定したときは、そのメッセージが表示されます。URLを指定したときは、そのURLにリダイレクトします。

_書式：_ `Options オプション`

ディレクトリごとにオプション機能を設定できます。指定できるオプションは表10-7のとおりです。

表10-7　Optionsディレクティブの主なオプション

|オプション|説明|
|---|---|
|ExecCGI|cgi-binディレクトリ以外でCGIプログラムを実行できる|
|Includes|SSI（Server Side Include）を許可する|
|Indexes|DirectoryIndexで指定されたファイルがない場合にファイル名一覧を生成する|
|FollowSymLinks|リンク先ファイルを参照する|
|ALL|すべてのオプションを利用する|
|None|すべてのオプションを無効にする|

## **10.1.4** 外部設定ファイル

httpd.conf以外のファイルに設定を記述し、httpd.confの設定を上書きすることもできます。たとえば、ユーザーのホームディレクトリ内に外部設定ファイルを配置し、オプションをユーザーが変更可能にすることもできます。外部設定ファイルの名前は、httpd.confファイル内のAccessFileNameディレクティブに指定されています。通常は「.htaccess」となっています。

▶ **外部設定ファイルの指定**

```
AccessFileName .htaccess
```

外部設定ファイルの利用を許可するには、httpd.confファイル内でAllowOverrideディレクティブを使って指定します。

_書式：_ `AllowOverride パラメータ`

表10-8　AllowOverrideディレクティブのパラメータ

|パラメータ|説明|
|---|---|
|AuthConfig|認証に関する設定を有効にする|
|Indexes|DirectoryIndexなどの設定を有効にする|
|FileInfo|ファイルタイプの制御設定を有効にする|
|Limit|Order、Allow、Denyによる設定を有効にする|
|Options|Optionsの設定を有効にする|
|None|.htaccessでの変更を無効にする|
|All|.htaccessで変更可能なすべての設定を有効にする|

複数のパラメータを指定することもできます。

▶ **.htaccessで認証とアクセス制御を利用可能にする**

```
AllowOverride AuthConfig Limit
```

## **10.1.5** Apache の制御

SysVinitを採用したシステムでApacheを起動するには、以下のようにします（Ubuntuでは「httpd」ではなく「apache2」）。

```
# /etc/init.d/httpd start
```

systemdを採用したシステムでApacheを起動するには、CentOSなどでは以下のようにします。

```
# systemctl start httpd.service
```

Ubuntuでは、httpdではなくapache2です。

```
# systemctl start apache2.service
```

Apacheの制御にはapachectlコマンドも利用できます。次の例では、Apacheを起動しています。

```
# apachectl start
```

_書式：_ `apachectl サブコマンド`

表10-9　apachectlコマンドの主なサブコマンド

|サブコマンド|説明|
|---|---|
|start|Apacheを起動する|
|stop|Apacheを終了する|
|restart|Apacheを再起動する|
|graceful|Apacheを安全に再起動する【注4】|
|reload|設定ファイルを再読み込みする|
|configtest|設定ファイルの構文をチェックする|

## **10.1.6** モジュールの利用

Apacheでは、さまざまな機能を持ったモジュールを必要に応じてロードしたりアンロードしたりすることができます【注5】。そのため、新しい機能を加える場合でも、Apache自体をあらためてコンパイルすることなく、必要なモジュールだけをコンパイルしてロードするだけですみます。Apacheの機能の多くはモジュールによって実現されています【注6】。

表10-10　Apacheの主なモジュール

|モジュール名|説明|
|---|---|
|mod_access_compat|ホストベースのアクセス制御|
|mod_authz_host|ホストベースのアクセス制御（Requireディレクティブ）|
|mod_authz_user|ユーザーベースのアクセス制御（Requireディレクティブ）|
|mod_auth_basic|基本認証|
|mod_auth_digest|ダイジェスト認証|
|mod_authn_file|.htaccessファイルを使ったユーザー認証|
|mod_alias|エイリアス機能の利用|
|mod_cgi|CGIスクリプトの実行|
|mod_dir|ディレクトリのインデックス表示|
|mod_info|サーバの設定情報表示|
|mod_log_config|リクエストログの生成|
|mod_mime|拡張子に応じたファイルタイプの判定|
|mod_negotiation|クライアントごとの自動判別機能の提供|
|mod_perl|Perlの利用|
|mod_php5|PHP5の利用|
|mod_proxy|プロキシ機能|
|mod_so|モジュールを組み込むDSO機能の提供|
|mod_ssl|SSL/TLS機能の利用|
|mod_status|サーバのステータス表示|
|mod_unixd|実行ユーザー・グループの指定やchroot 機能|
|mod_userdir|ユーザーディレクトリの公開|
|mod_version|バージョン依存の設定|

モジュールは/usr/lib/httpd/modulesディレクトリ以下などにインストールされます。モジュールをロードするには、httpd.confでLoadModuleディレクティブを使います。次の例では、Perlモジュールをロードするように設定しています。

```
LoadModule perl_module modules/mod_perl.so
```

Apacheのインストール後にモジュールを組み込むには、**apxsコマンド**を使います。次の例では、mod_foobarモジュールをDSOとしてコンパイルし、インストールしています。

```
$ sudo apxz -i -a -c mod_foobar.c
```

その後、httpd.confにLoadModuleディレクティブを追加します。

```
LoadModule foobar_module modules/mod_foobar.so
```

モジュールをApacheに静的に組み込んで利用することもできます。その場合は、Apacheのコンパイル時に--configureオプションで指定します。頻繁に利用するモジュールは、組み込んだほうがパフォーマンスは向上します。組み込み済みモジュールは、**httpd -lコマンド**で確認できます。

```
# httpd -l
Compiled in modules:
  core.c
  mod_so.c
  http_core.c
```

DebianやUbuntuの場合は、apache2 -lコマンドで確認できます。

```
$ sudo apache2 -l
Compiled in modules:
  core.c
  mod_so.c
  mod_watchdog.c
  http_core.c
  mod_log_config.c
  mod_logio.c
  mod_version.c
  mod_unixd.c
```

**httpd -Mコマンド**を使うと、組み込みモジュールとDSOモジュールの一覧を表示し、設定ファイルの文法チェックも行います。

```
# httpd -M
Loaded Modules:
  core_module (static)  <--- 組込みモジュール
  so_module (static)
  http_module (static)
  access_compat_module (shared) <--- DOSモジュール
  actions_module (shared)
  alias_module (shared)
(以下省略)
```

DebianやUbuntuの場合は、引数なしで**a2enmodコマンド**を実行すると、利用可能なモジュールを確認し、続けて対話的にモジュールを有効化できます。

```
$ sudo a2enmod
Your choices are: actions alias asis auth_basic auth_digest authn_alias authn_anon authn_dbd authn_dbm authn_default authn_file authnz_ldap authz_dbd authz_default authz_groupfile authz_host authz_owner authz_user autoindex cache cern_meta cgi cgid charset_lite dav dav_fs dav_lock dbd deflate dir disk_cache dump_io env
Which module(s) do you want to enable (wildcards ok)?
userdir
Enabling module userdir.
To activate the new configuration, you need to run:
  service apache2 restart
```

a2enmodコマンドでモジュールの有効化を、a2dismodコマンドでモジュールの無効化を実施できます。次の例では、rewriteモジュールを有効化しています。変更後にはApacheの再起動が必要です。

```
$ sudo a2enmod rewrite
Enabling module rewrite.
To activate the new configuration, you need to run:
  service apache2 restart
```

## **10.1.7** クライアントアクセスの認証

指定したディレクトリ以下にアクセスするとき、ユーザー名とパスワードがなければアクセスを拒否するよう制限をかけることができます。認証には**基本認証**（BASIC認証）と**ダイジェスト認証**が利用できます。また、IPアドレスやホスト名によるアクセス制御もできます。

### 基本認証

基本認証を利用するには、httpd.confにユーザー認証設定を追加し【注7】、専用のパスワードファイルを用意します。以下は、httpd.confの記述例です。

▶ **httpd.conf（一部）**

```
<Directory "/var/www/html/private-area">
    AuthType Basic
    AuthName "Please Enter Your ID and Password!"
    AuthUserFile /etc/httpd/conf/htpasswd
    Require valid-user
</Directory>
```

この例では、/var/www/html/private-area以下のディレクトリにアクセスする場合、ユーザー名とパスワードが求められます。

表10-11　基本認証に関するディレクティブ

|ディレクティブ|説明|
|---|---|
|AuthType|基本認証の場合は「Basic」|
|AuthName|認証の際のダイアローグボックスに出力されるメッセージ|
|AuthUserFile|パスワードファイル名|
|AuthGroupFile|認証するグループファイル名|
|Require|アクセス可能なユーザー（ユーザー名またはvalid-user）|

Require valid-userとすると、パスワードファイルにエントリのあるすべてのユーザーがアクセスを許可されます。valid-userの代わりに「user ユーザー名...」のようにユーザー名を列挙すると、指定したユーザーのみが許可されます。

認証に用いられるユーザー名とパスワードを設定するには、**htpasswdコマンド**を使います。

_書式：_ `htpasswd [オプション] ファイル名 ユーザー名`

表10-12　htpasswdコマンドの主なオプション

|オプション|説明|
|---|---|
|-c|パスワードファイルを新規に作成する|
|-m|MD5で暗号化する|
|-s|SHA1で暗号化する|
|-D|ユーザーを削除する|

次の例では、/etc/httpd/conf/htpasswdをパスワードファイルとして、lpicuserのアカウントを作成しています。

```
# htpasswd -c /etc/httpd/conf/htpasswd lpicuser
New password:
Re-type new password:
Adding password for user lpicuser
```

**注意**
ドキュメントルート以下の、ブラウザからアクセス可能なディレクトリ内にパスワードファイルを配置する場合は、パスワードファイルがブラウザからアクセスできないよう注意してください。ファイル名を.htpasswdなど、.htで始まzる名前にすると、ブラウザからのアクセスを防ぎます。デフォルトでは、.htで始まる名前のファイルにはアクセスできないよう設定されています。

作成済みユーザーのパスワードを変更する場合にも、パスワードファイルの指定は必要です。次の例では、lpicuserユーザーのパスワードを変更しています。

```
# htpasswd /etc/httpd/conf/htpasswd lpicuser
```

パスワードファイルの内容は次のようになっています。

▶ **基本認証パスワードファイルの内容例**

```
lpicuser:$apr1$L8HJwh7z$H08KR2LA193DAXV8vc0wn1
```

グループ単位で基本認証を設定する場合は、AuthGroupFileでグループパスワードファイルを指定します。パスワードファイルには次の書式でユーザーを指定します。

_書式：_ `グループ名: ユーザー名1 ユーザー名2 ...`

指定したユーザーは、それぞれhtpasswdコマンドでパスワードを設定しておきます。また、requireディレクティブでは、次の書式でグループ名を指定します。

_書式：_ `require group グループ名`

### ダイジェスト認証

基本認証では、パスワードが平文【注8】でネットワーク上を流れるので、SSL/TLSなどと組み合わせない限り安全とはいえません。ダイジェスト認証はチャレンジ・レスポンス形式の認証を行うので、盗聴されてもただちにパスワードが漏洩することはありません。

▶ **httpd.conf（一部）**

```
<Directory "/var/www/html/secret-area">
    AuthType Digest
    AuthName "secret-area"
    AuthUserFile /etc/httpd/conf/htdigestfile
    Require valid-user
</Directory>
```

この例では、/var/www/html/secret-area以下のディレクトリにアクセスする場合、ユーザー名とパスワードが求められます。

表10-13　ダイジェスト認証に関するディレクティブ

|ディレクティブ|説明|
|---|---|
|AuthType|ダイジェスト認証の場合は「Digest」|
|AuthName|認証の領域|
|AuthUserFile|パスワードファイル名|
|AuthDigestGroupFile|認証するグループファイル名|
|Require|アクセス可能なユーザー（ユーザー名またはvalid-user）|

AuthNameディレクティブの扱いが基本認証とは異なり、ユーザー認証を行う領域を指定します。領域名が異なれば、たとえ同じパスワードファイルを使って認証を行ったとしても認証できないので注意してください。

ダイジェスト認証のためのユーザー作成やパスワード変更には**htdigestコマンド**を使います。

_書式：_ `htdigest [オプション] ファイル名 領域 ユーザー名`

表10-14　htdigestコマンドの主なオプション

|オプション|説明|
|---|---|
|-c|パスワードファイルを新規に作成する|

次の例では、/etc/httpd/conf/htdigestをパスワードファイルに、領域名は「secret-area」として、lpicuserのアカウントを作成しています。

```
# htdigest -c /etc/httpd/conf/htdigest secret-area lpicuser
Adding password for lpicuser in realm secret-area.
New password:
Re-type new password:
```

パスワードファイルの内容は次のようになっています。

▶ **ダイジェスト認証パスワードファイルの内容例**

```
lpicuser:secret-area:04c2c01fab113093ceffd7614dc42b84
```

**ここが重要**

● 基本認証とダイジェスト認証の設定手順およびコマンドに馴染んでおく必要があります。

### ホストベースのアクセス制御（1）

Order、Allow、Denyディレクティブを使って、IPアドレス【注9】もしくはホスト名、ドメイン名でアクセス制御ができます。以上の機能はmod_access_compatモジュールによって提供されますが、すでに非推奨となっており、後述のRequireディレクティブを使った設定を行うようにしてください。

_書式：_ `Order allow|deny`

_書式：_ `Allow from IP アドレスまたはホスト名・ドメイン名`

_書式：_ `Deny from IP アドレスまたはホスト名・ドメイン名`

Allowディレクティブには接続を許可するホストを、Denyディレクティブには接続を拒否するホストを指定します。Orderディレクティブでは、AllowとDenyの評価順を指定します。

表10-15　Orderディレクティブ

|設定|評価順|デフォルト|
|---|---|---|
|Order allow,deny|Allow → Deny|拒否|
|Order deny,allow|Deny → Allow|許可|

次の例では、172.31.0.0/16のホストからはアクセスを拒否し、それ以外のホストからのアクセスは許可します。2パターンの設定が可能です。

▶ **パターン1**

```
Order allow,deny
Allow from all
Deny from 172.31.0.0/16
```

▶ **パターン2**

```
Order deny,allow
Deny from 172.31.0.0/16
```

次の例では、172.31.0.0/16のホストからはアクセスを拒否（例外的に172.31.0.1のホストは許可）し、それ以外のホストからのアクセスは許可します。

▶ **アクセス制御の設定例**

```
Order deny,allow
Deny from 172.31.0.0/16
Allow from 172.31.0.1
```

### ホストベースのアクセス制御（2）

IPアドレスやホスト名、ドメイン名などでアクセス制御をしたい場合は、Requireディレクティブを使います。この機能はauthz_host_moduleモジュールによって提供されます。Apache 2.4では、旧来のOrder、Allow、Denyディレクティブではなく、こちらの書式を使ってください。

_書式：_ `Require エンティティ [値...]`

アクセスを許可する対象を記述するエンティティには、表10-16のような表現が使えます。

表10-16　Requireディレクティブで指定するエンティティの例

|エンティティ|説明|
|---|---|
|ip 192.168.1.25|192.168.1.25|
|ip 172.20 192.168.2|172.20.0.0/16および192.168.2.0/24のみ|
|host example.org|example.orgのホストのみ|
|group admin|adminグループのみ|
|all granted|すべてのホストを許可|
|all denied|すべてのホストを拒否|
|local|ローカルホストのみ|

また、以下のディレクティブを使って、複数の条件を指定したアクセス制御ができます。デフォルトはRequireAnyです。

表10-17　アクセス制御ディレクティブ

|ディレクティブ|説明|
|---|---|
|RequireAll|すべての条件にマッチすれば真|
|RequireAny|1つ以上の条件にマッチすれば真|
|RequireNone|いずれの条件にもマッチしなければ真|

次の例では、172.31.0.0/16のホストからはアクセスを拒否し、それ以外のホストからのアクセスは許可します。

▶ **設定例1**

```
Require all granted
Require not ip 172.31
```

## **10.1.8** バーチャルホスト

Apacheが備えている**バーチャルホスト**機能を利用すると、1 台のサーバで複数のWebサイトを管理することができます。バーチャルホストには、1 台のコンピュータに1つのIPアドレスと複数のドメイン名を設定する**名前ベースのバーチャルホスト**と、1 台のコンピュータに複数のIPアドレスと複数のドメイン名を設定する**IPベースのバーチャルホスト**があります。ここでは、1つのApacheで[web.lpic.jp](http://web.lpic.jp/)、[www.example.net](http://www.example.net/)を運用する例を取り上げます。

### 名前ベースのバーチャルホスト

名前ベースのバーチャルホストでは、バーチャルホストごとの設定をVirtualHostディレクティブ内に記述します。

▶ **名前ベースのバーチャルホスト**

```
# 1つめのバーチャルホスト設定
<VirtualHost *:80>
    ServerName web.lpic.jp
    ServerAdmin webmaster@web.lpic.jp
    DocumentRoot /var/www/virtual/lpic
</VirtualHost>

# 2つめのバーチャルホスト設定
<VirtualHost *:80>
    ServerName www.example.net
    ServerAdmin webmaster@www.example.net
    DocumentRoot /var/www/virtual/example
</VirtualHost>
```

すでに稼働しているWebサーバにバーチャルホストを追加する場合、既存のホストも1つのバーチャルホスト設定として設定する必要があります。

DNSを適切に設定すれば、それぞれのWebサイトを独立して運用することができます。

### IP ベースのバーチャルホスト

IPベースのバーチャルホストでは、バーチャルホストごとの設定をVirtualHostディレクティブ内に記述します。VirtualHostディレクティブではIPアドレスを指定します【注10】。また、ListenディレクティブでそれぞれのIPアドレスを指定しておきます。

▶ **IPベースのバーチャルホスト**

```
Listen 192.168.1.10:80
Listen 192.168.1.11:80

（中略）

# 1つめのバーチャルホスト設定
<VirtualHost 192.168.1.10:80>
    ServerName web.lpic.jp
    ServerAdmin webmaster@web.lpic.jp
    DocumentRoot /var/www/virtual/lpic
</VirtualHost>

# 2つめのバーチャルホスト設定
<VirtualHost 192.168.1.11:80>
    ServerName www.example.net
    ServerAdmin webmaster@www.example.net
    DocumentRoot /var/www/virtual/example
</VirtualHost>
```

## **10.1.9** SSL/TLS

**SSL**（Secure Socket Layer）は、TCP/IPとアプリケーション層との中間に実装されている、**公開鍵暗号**を使ったセキュリティ技術です。公開鍵暗号では、公開鍵と秘密鍵のペアを使って暗号化と復号を行います。SSLを使うと、WebブラウザとWebサーバ間の通信を暗号化することで、セキュアな通信を行うことができます。また、認証局によって発行された**サーバ証明書**（サイト証明書）を使って、サイトの正当性を証明することができます。セキュアなWebサーバは、SSLによる通信の暗号化とサーバ証明書を使ってセキュリティを実現します。Apacheではmod_sslモジュールを利用することでSSLに対応します。

SSLを利用してWebサーバを運用するには、mod_sslモジュールが利用できるようになっていることに加え、次のような手順でサイト証明書を認証局から入手する必要があります。

1. 公開鍵と暗号鍵を作成する
2. 作成した公開鍵を、利用企業の身元を証明する書類、手数料などとともに、認証局（CA【注11】）へ送付する
3. CAでは証明書を発行して返送する。この証明書を使って、WebサーバがWebブラウザに対して身元を明らかにする
4. 送られてきた証明書をWebサーバにインストールする【注12】

なお、サーバ証明書はIPアドレスまたはドメイン名に対して発行されます。

ここでは、サイト自身を独自の認証局とし、その認証局によって証明書に署名を行う方法を採り上げます（自己署名証明書）。まずは、認証局を作成します。SSLがインストールされたディレクトリ内にCA.shというスクリプトが用意されているので、それをコピーして対話的に作成します。

```
# cd /etc/pki/tls/misc/
[root@centos7 misc]# ./CA -newca
CA certificate filename (or enter to create)

Making CA certificate ...
Generating a 2048 bit RSA private key
...............................................................................+++
.......+++
```


```
writing new private key to '/etc/pki/CA/private/./cakey.pem'
Enter PEM pass phrase: ＊＊＊＊＊
Verifying - Enter PEM pass phrase: ＊＊＊＊＊

You are about to be asked to enter information that will be incorporated into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.

-----
Country Name (2 letter code) [XX]:JP              ←国コード
State or Province Name (full name) []:Tokyo       ←州または県名
Locality Name (eg, city) [Default City]:Shinjuku  ←市区町村名
Organization Name (eg, company) [Default Company Ltd]:Example Corp  ←会社名
Organizational Unit Name (eg, section) []:Network   ←部署名
Common Name (eg, your name or your server's hostname) []:centos7.example.com  ←ホストのFQDN
Email Address []:info@example.com  ←管理者のメールアドレス

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:  ←挑戦用パスワード
An optional company name []:  ←省略

Using configuration from /etc/pki/tls/openssl.cnf
Enter pass phrase for /etc/pki/CA/private/./cakey.pem: ＊＊＊＊＊
1404989182771392:error:28069065:lib(40):UI_set_result:result too small:ui_lib.c:...
Enter pass phrase for /etc/pki/CA/private/./cakey.pem: ＊＊＊＊＊
Check that the request matches the signature
Signature ok
Certificate Details:
    Serial Number: 119451324151352625 (0x8a5c3a22d8e88b55)
    Validity
        Not Before: Jan 4 16:13:32 2017 GMT
        Not After : 
        Subject:
            countryName               = JP
            stateOrProvinceName       = Tokyo
            organizationName          = Example Corp
            organizationalUnitName    = Network
            commonName                = centos7.example.com
            emailAddress              = info@example.com
    X509v3 extensions:
        X509v3 Subject Key Identifier: 
            5A:45:40:14:87:01:77:BF:54:44:77:08:F7:CD:0B:98:12:29:9E:78
        X509v3 Authority Key Identifier: 
            keyid:5A:45:40:14:87:01:77:BF:54:44:77:08:F7:CD:0B:98:12:29:9E:78

        X509v3 Basic Constraints: 
            CA:TRUE
Certificate is to be certified until Jan 4 16:13:32 2020 GMT (1095 days)

Write out database with 1 new entries
Data Base Updated
```

秘密鍵が/etc/pki/CA/private/cakey.pemとして、自己署名証明書が/etc/pki/CA/cacert.pemとして作成されます。
次に、SSL対応HTTPサーバを構築するために必要となるサーバ秘密鍵を作成します。ファイル名はserver.keyとしています。

```
# openssl genrsa -out server.key 2048
Generating RSA private key, 2048 bit long modulus
............................+++
...........+++
e is 65537 (0x10001)
```

次に、認証局に対して証明書の発行を要求する**証明書発行要求書**（CSR）を作成します。次のコマンドで、証明書発行要求ファイルserver.csrを作成できます。

```
# openssl req -new -key server.key -out server.csr
（中略）
-----

Country Name (2 letter code) [XX]:JP  ←国コード
State or Province Name (full name) []:Tokyo  ←都道府県名
Locality Name (eg, city) [Default City]:Shinjuku  ←市区町村名
Organization Name (eg, company) [Default Company Ltd]:Example Corp  ←会社名
Organizational Unit Name (eg, section) []:Network  ←部署名
Common Name (eg, your name or your server's hostname) []:centos7.example.com  ←ホストのFQDN
Email Address []:info@example.com  ←管理者のメールアドレス

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:  
An optional company name []:  
```

証明書発行要求ファイルに対して認証局が署名を行い、サーバ証明書server.crtを作成します。

```
# openssl ca -out server.crt -infiles /etc/pki/CA/server.csr
Using configuration from /etc/pki/tls/openssl.cnf
Enter pass phrase for /etc/pki/CA/private/cakey.pem: ＊＊＊＊＊
Check that the request matches the signature
Signature ok
Certificate Details:
    Serial Number: 1194513241513261526 (0x8a5c5a2ad23e88b56)
    Validity
        Not Before: Jan 4 16:20:41 2017 GMT
        Not After : Jan 4 16:20:41 2018 GMT
    Subject:
        countryName               = JP
        stateOrProvinceName       = Tokyo
        organizationName          = Example Corp
        organizationalUnitName    = Network
        commonName                = centos7.example.com
        emailAddress              = info@example.com
    X509v3 extensions:
        X509v3 Basic Constraints: 
            CA:FALSE
        Netscape Comment:
            OpenSSL Generated Certificate
        X509v3 Subject Key Identifier: 
            5E:B5:3F:E1:60:DB:C4:EA:4F:EF:18:76:7C:87:81:B5:58:40:3A:9E
        X509v3 Authority Key Identifier: 
            keyid:5A:45:40:14:87:01:77:BF:54:44:77:08:F7:CD:0B:98:12:29:9E:78

Certificate is to be certified until Jan 4 16:20:41 2018 GMT (365 days)
Sign the certificate? [y/n]:y
```

ここで、SSL関連ファイルをまとめておきます。

表10-18　SSL 関連ファイル

|ファイル名|説明|
|---|---|
|server.key|サーバ秘密鍵|
|server.csr|認証局に対する証明書発行要求書|
|server.crt|サーバ証明書|

サーバ秘密鍵とサーバ証明書を適切なディレクトリに移動し、httpd.confに必要な設定を記述します【注13】。次の例は重要な設定だけを抜粋したものです。

▶ **SSLの設定**

```
LoadModule ssl_module modules/mod_ssl.so
Listen 443
（以下省略）
<VirtualHost _default_:443>
    DocumentRoot "/var/www/html"  ←ドキュメントルートを設定
    ServerName www.example.net:443  ←ホスト名を設定
    ErrorLog logs/ssl_error_log
    TransferLog logs/ssl_access_log
    LogLevel warn
    SSLEngine on
    SSLProtocol all -SSLv2 -SSLv3  ←SSLv2/SSLv3は無効
    SSLCertificateFile /etc/httpd/conf/ssl.crt/server.crt  ←サーバ証明書
    SSLCertificateKeyFile /etc/httpd/conf/ssl.key/server.key  ←サーバ秘密鍵
</VirtualHost>
```

表10-19　SSL/TLS関連の主要なディレクティブ

|ディレクティブ|説明|
|---|---|
|SSLEngine|SSL/TLSの有効／無効（on、off）|
|SSLProtocol|SSL/TLSプロトコルのバージョン（all、SSLv2、SSLv3、TLSv1、TLSv1.1、TLSv1.2）。-を付けると無効化、+を付けると有効化|
|SSLCipherSuite|SSL/TLSで利用する暗号アルゴリズムのリスト|
|SSLCertificateFile|サーバ証明書ファイル|
|SSLCertificateKeyFile|サーバ秘密鍵ファイル|
|SSLCertificateChainFile|中間CA証明書ファイル|
|SSLCACertificateFile|クライアント証明書発行のCA 証明書ファイル|
|SSLCACertificatePath|クライアント証明書発行のCA 証明書ディレクトリ|
|SSLVerifyClient|クライアント認証のレベル（none、optional、optional_no_ca、require）|

SSLでアクセスするには、リクエストURLを「https://〜」とします。通信には一般的に、443 番ポートが使われます。

**コラム**
**SNI（Server Name Indication）**
もともと、1つのサーバ（1つのグローバルIPアドレス）では、SSL/TLS証明書は1つのドメインだけしか運用できませんでした。つまり、名前ベースのバーチャルホスト機能を使って複数の独自ドメインを運用していても、すべてのドメインでSSL/TLS対応にすることはできなかったのです。1つのSSL/TLS証明書を全バーチャルホストで共有する共有SSLという方式もありますが、SSL 対応ページに訪問するとドメインが切り替わってしまいます。
SNI（Server Name Indication）を利用すると、1つのWebサーバで複数ドメインのSSL/TLS 証明書を利用することができます。SNIはSSL/TLSを拡張する仕様で、RFC6066で規定されています。SNI対応のWebブラウザが必要ですが、最近のWebブラウザはほぼ対応済みです。

# 10.2 Webサーバの監視とメンテナンス

Webサーバを安定して稼働させるためには、サーバの状態を適切に把握することと、ログの確認が大切です。

## **10.2.1** サーバ情報の取得

mod_statusモジュールを利用すると、サーバの稼働状況についての情報をWebブラウザに表示させることができます。また、mod_infoモジュールを利用すると、サーバの設定に関する情報を表示させることができます。次に示すのは、それぞれのモジュールを利用するためのhttpd.confの設定です【注14】。

▶ **mod_statusを利用するためのhttpd.confの設定**

```
LoadModule status_module modules/mod_status.so
（中略）
<Location /server-status>
    SetHandler server-status
</Location>
```

▶ **mod_infoを利用するためのhttpd.confの設定**

```
LoadModule info_module modules/mod_info.so
（中略）
<Location /server-info>
    SetHandler server-info
</Location>
```

図10-1は、mod_statusモジュールを使っているサイトで、http://ホスト名/server-statusにアクセスしたときの表示例です。
![[_resource/00559.jpeg]]
図10-1　mod_statusを使った表示例

図10-2は、mod_infoを使っているサイトで、http://ホスト名/server-infoにアクセスしたときの表示例です。
![[_resource/00560.jpeg]]
図10-2　mod_infoを使った表示例

## **10.2.2** ログファイル

Apacheのログには主に、**アクセスログファイル**と**エラーログファイル**があり、/var/log/httpdディレクトリ以下などに格納されます。アクセスログファイルaccess_logには、クライアントからのリクエストが記録されます。以下はaccess_logファイルの一部です。

▶ **access_log（一部）**

```
10.156.215.77 - - [01/Jan/2017:14:34:37 +0900] "GET /vm/index.html HTTP/1.1" 200 1131 "http://www.example.net/books/101068.php" "Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/55.0.2883.87 Safari/537.36"
10.156.215.77 - - [01/Jan/2017:14:34:37 +0900] "GET /vm/la.css HTTP/1.1" 200 1612 "http://www.example.net/vm/index.html" "Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/55.0.2883.87 Safari/537.36"
10.156.215.77 - - [01/Jan/2017:14:34:37 +0900] "GET /vm/lpic1w02.jpg HTTP/1.1" 200 63778 "http://www.example.net/vm/index.html" "Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/55.0.2883.87 Safari/537.36"
10.156.215.77 - - [01/Jan/2017:14:34:38 +0900] "GET /vm/lpic1w01.jpg HTTP/1.1" 200 18335 "http://www.example.net/vm/index.html" "Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/55.0.2883.87 Safari/537.36"
```

アクセスログにどのような情報が保存されるか、というログのフォーマットはhttpd.conf内で設定します。LogFormatディレクティブでフォーマットを指定し、CustomLogディレクティブでログファイル名とフォーマットを結びつけます。

▶ **ログフォーマットの定義**

```
LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
LogFormat "%h %l %u %t \"%r\" %>s %b" common
LogFormat "%{Referer}i -> %U" referer
LogFormat "%{User-agent}i" agent

CustomLog logs/access_log combined  ←combined形式でaccess_logを保存
```

エラーログファイルerror_log【注15】には、さまざまなエラー情報やサーバの挙動が記録されます。記録するエラー情報のログレベルは、LogLevelディレクティブによって指定することができます。以下はerror_logファイルの一部です。

▶ **error_logの一部**

```
[Sun Jan 01 11:14:05 2017] [error] [client 176.9.50.43] Directory index forbidden by Options directive: /var/www/html/
[Sun Jan 01 12:29:03 2017] [error] [client 119.172.132.21] File does not exist: /var/www/html/favicon.ico
[Sun Jan 01 21:34:52 2017] [error] [client 108.76.15.27] File does not exist: /var/www/html/robots.txt
```

# 10.3 プロキシサーバの設定

**プロキシサーバ**を使う利点は2つあります。1つは、ローカルネットワークからインターネットへのアクセスを代行することにより、特定のWebサイトへのアクセスを制限するなど、クライアントからのアクセスを制御できることです。もう1つは、一度アクセスされたデータをキャッシュとして保存し、再度同じアクセスがあった場合はキャッシュデータを返すことで、アクセスを高速化し、ネットワークトラフィックを削減することができることです。

## **10.3.1** Squid の基本設定

Linuxでもっともよく利用されているプロキシサーバはSquidです。**Squid**の設定は**squid.conf**（/etc/squid/squid.confなど）で行います。

表10-20　squid.confの設定項目


|設定項目|説明|
|---|---|
|http_port|Squidが利用するポート番号|
|visible_hostname|ホスト名|
|hierarchy_stoplist|キャッシュを利用しない文字列|
|maximum_object_size|キャッシュ可能な最大ファイルサイズ|
|minimum_object_size|キャッシュ可能な最小ファイルサイズ（0は無制限）|
|maximum_object_size_in_memory|メモリ上の最大ファイルサイズ|
|ipcache_size|キャッシュするIPアドレス数|
|cache_dir|キャッシュを格納するディレクトリと容量などのパラメータ|
|cache_mem|メモリ上のキャッシュサイズ|
|cache_access_log|クライアントのアクセスログ|
|cache_log|キャッシュのログ|
|ftp_user|anonymousでFTPアクセスする際のパスワード|
|ftp_passive on\|off|FTPのパッシブモードの有効/ 無効|
|reference_age|キャッシュの保存期間|
|request_header_max_size|HTTPリクエストヘッダの最大サイズ|
|request_body_max_size|HTTPリクエストボディの最大サイズ|
|reply_body_max_size|レスポンスの最大ボディサイズ（0は無制限）|
|acl|アクセスコントロールリストの設定|
|http_access|アクセスコントロールリストの制御|

▶ **squid.confの設定例**

```
# NETWORK OPTIONS
http_port 8080  ←8080番ポートを利用
visible_hostname lpic2.example.net  ←ホスト名

# OPTIONS WHICH AFFECT THE NEIGHBOR SELECTION ALGORITHM
hierarchy_stoplist cgi-bin ?  ←cgi-binまたは「？」を含むURLを上位のキャッシュを経由せずにバイパスする
acl QUERY urlpath_regex cgi-bin \?  ←禁止するURLを正規表現で指定
no_cache deny QUERY  ←上の行で設定したACLを適用

# OPTIONS WHICH AFFECT THE CACHE SIZE
cache_mem 20MB  ←キャッシュサイズは20MB
maximum_object_size 4096KB  ←キャッシュ可能なファイルサイズは4MB
minimum_object_size 0KB  ←最小オブジェクトサイズの制限なし
maximum_object_size_in_memory 8KB  ←メモリ内にキャッシュする最大オブジェクトサイズは8KB
ipcache_size 1024  ←キャッシュするIPアドレス数は1024個

# LOGFILE PATHNAMES AND CACHE DIRECTORIES
cache_dir ufs /var/spool/squid 100 16 256  ←キャッシュディレクトリのサイズ（MB）、ディレクトリ数、サブディレクトリ数
cache_access_log /var/log/squid/access.log  ←クライアントアクセスログ
cache_log /var/log/squid/cache.log  ←キャッシュログ
cache_store_log /var/log/squid/store.log  ←ストアトランザクションログ

# OPTIONS FOR EXTERNAL SUPPORT PROGRAMS
ftp_user lpic2@example.net  ←匿名FTPのパスワード
ftp_passive on  ←パッシブモード

# OPTIONS FOR TUNING THE CACHE
request_header_max_size 10KB  ←HTTPリクエストヘッダの最大許容サイズ
request_body_max_size 1MB  ←HTTPリクエストボディの最大許容サイズ
reply_body_max_size 0  ←レスポンスの最大ボディ長制限なし
```

## **10.3.2** アクセス制御の設定

アクセス制限の設定は、aclとhttp_accessで行います。aclでは、ホストやプロトコルの集合にアクセスコントロールリスト名を付けます。

_書式：_ `acl ACL 名 ACL タイプ 文字列もしくはファイル名`

ACLタイプは次のとおりです。

表10-21　ACLタイプ

|ACLタイプ|説明|
|---|---|
|src|クライアント側のIPアドレス|
|dst|代理アクセス先サーバのIPアドレス|
|srcdomain|クライアントのドメイン名|
|dstdomain|代理アクセス先サーバのドメイン名|
|port|代理アクセス先サーバのポート番号|
|myport|クライアントのポート番号|
|arp|MACアドレス|
|proto|プロトコル|
|method|HTTPのメソッド|
|url_regex|URLにマッチする正規表現|
|urlpath_regex|URLからプロトコルとホスト名を除いたパス名にマッチする正規表現|
|time|有効な時刻を指定する（「10:00-12:00」など）|

アクセスコントロールリストに対しての制御をhttp_accessで設定します。

_書式：_　`http_access allow|deny ACL名`

まずは単純な例を見てみましょう。次の例では、192.168.0.0/24からのアクセスを禁止しています。

▶ **アクセス制御の設定例**

```
acl badhosts src 192.168.0.0/255.255.255.0
http_access deny badhosts
```

次に示すのはsquid.confの設定例です。

▶ **squid.conf（アクセス制御部分のみ）**

```
# ACCESS CONTROLS
acl all src 0.0.0.0/0.0.0.0
acl localhost src 127.0.0.1/255.255.255.255
acl clients src 192.168.0.0/255.255.255.0
acl denydomain dstdomain example.com example.jp
acl blacklist url_regex "/etc/squid/url_blacklist.txt"
acl SSL_ports port 443 563
acl Safe_ports port 80 21 443 563 70 210 1025-65535
acl CONNECT method CONNECT

http_access deny !Safe_ports  ← Safe_portsで指定されたポート番号以外へのアクセスを禁止
http_access deny CONNECT !SSL_ports  ← SSL_portsで指定されたポート番号以外のCONNECTメソッドを禁止

http_access deny denydomain  ← denydomainで指定されたドメインへのアクセスを禁止
http_access deny blacklist  ← blacklistに含まれるURLへのアクセスを禁止
http_access allow localhost  ← localhostからのアクセスを許可
http_access allow clients  ← clientsからのアクセスを許可
http_access deny all  ← すべてのアクセスを拒否
```


**ここが重要**
● squid.confの設定、とりわけアクセス制御設定については確実に理解してください。


# 10.4 Nginxとリバースプロキシの設定

**Nginx**（エンジンエックス）【注16】は、高速で動作し負荷に強いWebサーバです。また、リバースプロキシサーバ、メールプロキシサーバの機能も有しています。

## **10.4.1** Nginx の設定

Nginxは、1つのマスタープロセス（master process）と、複数のワーカープロセス（worker process）から構成されます。クライアントからのHTTP要求を受け付け、処理をするのがワーカープロセスです。マスタープロセスはワーカープロセスを管理するためのプロセスです。

```
$ ps auxw | grep nginx
root      1575  0.0  0.1 15636 1496 ?        Ss   01:30   0:00
nginx     1576  0.0  0.1 15792 1984 ?        S    01:30   0:00 nginx: master process /usr/sbin/nginx -c /etc/nginx/nginx.conf
nginx     1577  0.0  0.1 15792 1984 ?        S    01:30   0:00 nginx: worker process
nginx     1578  0.0  0.1 15792 2024 ?        S    01:30   0:00 nginx: worker process
```

Nginxのメイン設定ファイルは/etc/nginx/nginx.confです。ディストリビューションによっては、/etc/nginxディレクトリおよび/etc/nginx/conf.dディレクトリ以下に複数のファイルを配置し、nginx.confに読み込んで利用する場合もあります。

表10-22　nginxの主な設定ファイル（CentOS）

|ファイル|説明|
|---|---|
|/etc/nginx/nginx.conf|メイン設定ファイル|
|/etc/nginx/conf.d/default.conf|デフォルトサーバの設定ファイル|
|/etc/nginx/conf.d/ssl.conf|SSLの設定ファイル|
|/etc/nginx/conf.d/virtual.conf|バーチャルホストの設定ファイル|

設定は、ディレクティブに値を指定する形で記述します。設定行の末尾には「;」が必要です。また、「#」で始まる行はコメントです。

_書式：_　`ディレクティブ　値;`

ブロック構造をとるディレクティブもあります。ブロックの範囲は{ }で表します。{ }の末尾には「;」は不要です。

_書式：
```
ディレクティブ {  
　　他のディレクティブ;  
　　...  
　}
```


ブロックを入れ子にした場合、親ブロックで設定した内容は子ブロックに引き継がれます。ただし、子ブロックで再設定することもできます。

nginx.confの基本的な構造を見ておきましょう。

▶ **nginx.confの基本的な構造**

```
#
# プロセス制御などを設定するmainコンテキスト
# (coreモジュールの設定)
#
events {
    # 接続処理についての設定
    # (eventsモジュールの設定)
}
http {
    # HTTPサーバの設定
    # (httpモジュールの設定)
    server {
        # HTTPサーバごとの設定
        location /パス {
            # URIごとの設定
        }
    }
}
mail {
    # メールプロキシ関連の設定
    # (mailモジュールの設定)
}
```

Nginxはさまざまな機能を実現するモジュール構造となっています。代表的なモジュールが、coreモジュール、eventsモジュール、httpモジュール、mailモジュールです。ディレクティブはどこに記述してもよいわけではなく、記述すべきコンテキストが決められています。コンテキストとは、たとえばhttpモジュールであれば「http{ 〜 }」内を示します。coreモジュールによるmainコンテキストのみ、{ }による構造は示しません。

コンテキスト内にはさまざまなディレクティブでパラメータを指定します。

表10-23　nginx.confの主なディレクティブ

|ディレクティブ|コンテキスト|説明|
|---|---|---|
|include|すべて|他の設定ファイルを読み込む|
|user|main|workerプロセスの実行ユーザー|
|worker_processes|main|workerプロセス数（CPUコア数）【注17】|
|worker_connections|events|1つのworkerプロセスが同時に処理できる最大コネクション数|
|log_format|http|アクセスログの書式定義|
|access_log|http, server, location|アクセスログのパスとログレベル|
|error_log|main, http, server, location|エラーログファイルのパスとログレベル|
|listen|server|リクエストを受け付けるポート番号|
|server_name|server|サーバ名（バーチャルホスト名）|
|keepalive_requests|http, server, location|一度の接続で受け付けることができるリクエスト数の上限|
|keepalive_timeout|http, server, location|キープアライブのタイムアウトまでの秒数（0でキープアライブが無効になる）|
|server_tokens|http, server, location|バージョン番号の表示（offで非表示）|
|root|http, server, location|ドキュメントルート|
|index|http, server, location|インデックスファイル|
|autoindex|http, server, location|インデックスリスト表示のon ／ off|
|error_page|http, server, location|エラーコードとエラーページのURI|

  

設定例を次に示します。

▶ **nginx.confの設定例**

```
# 全体設定
user  nginx;
worker_processes  2;
error_log  /var/log/nginx/error.log;

events {
    worker_connections  1024;
}

http {
    include       /etc/nginx/mime.types;
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';
    access_log  /var/log/nginx/access.log  main;
    keepalive_timeout  65;

    # メインサーバの設定
    server {
        listen       80;
        server_name  www.example.com;

        location / {
            root   /usr/share/nginx/html;
            index  index.html index.htm;
        }

        error_page  404              /404.html;
        location = /404.html {
            root   /usr/share/nginx/html;
        }

        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   /usr/share/nginx/html;
        }
    }

    （以下省略）
}
```


## **10.4.2** リバースプロキシの設定

Nginxはリバースプロキシサーバとしてよく利用されています。**リバースプロキシ**とは、Webサーバとクライアントとの間で稼働し、Webサーバのコンテンツをキャッシュしてクライアントに提供するサーバです。リバースプロキシを使うと、Webサーバの負荷を軽減できます。次に示すのは、リバースプロキシとしてNginxを利用する場合の設定例です。ローカルホストで稼働しているWebサーバが8080 番ポートで待ち受けしているものとします。

▶ **nginx.conf（抜粋）**

```
server {
    location / {
        proxy_pass http://localhost:8080;
    }
}
```

次の例では、キャッシュも有効にします。

▶ **nginx.conf（抜粋）**

```
server {
    location / {
        proxy_pass http://localhost:8080;

        proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=czone:4m max_size=10m inactive=3d;
        proxy_temp_path /var/tmp/nginx;
        proxy_cache_key "$scheme://$host$request_uri";
    }
}
```

前記の設定では、Webサーバのアクセスログには、クライアントからのアクセスではなく、リバースプロキシ（前記の例ではローカルホスト）からのアクセスが記録されます。本来のアクセス元をWebサーバが記録できるようにするには、HTTPヘッダを転送するよう設定する必要があります。次の設定例のとおり、proxy_set_headerディレクティブで指定します。

▶ **nginx.conf（抜粋）**

```
server {
    location / {
        proxy_pass http://localhost:8080;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Server $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```
